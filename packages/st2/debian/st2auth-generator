#!/bin/bash

NORMAL_DIR=${1:-/tmp}
EARLY_DIR=${2:-/tmp}
LATE_DIR=${3:-/tmp}

ST2SVC="st2auth"
DEFAULT_IP="127.0.0.1"
DEFAULT_PORT="9100"

function nolog() {
    true
}

function debug() {
    echo "$(/bin/date) - ${1}" | /usr/bin/tee -a ${NORMAL_DIR}/${ST2SVC}_generator.log
}

function writef() {
    # cat with bash here document requires write access to a tmp directory which is unavailable when
    # generators are run during boot because the root filesystem is mounted readonly, so we use echo.
    echo "$1" >> "${NORMAL_DIR}/${ST2SVC}.socket"
}

function log() {
    # call nolog / debug to enable/disable logging.
    nolog "$1"
}

log "Supplied directories: Early='${EARLY_DIR}' Normal='${NORMAL_DIR}' Late='${LATE_DIR}'"

BIND_HOST=$(/usr/bin/crudini --get /etc/st2/st2.conf ${ST2SVC:3} host 2>/dev/null || echo ${DEFAULT_IP})
log "Host bind='${BIND_HOST}'"

BIND_PORT=$(/usr/bin/crudini --get /etc/st2/st2.conf ${ST2SVC:3} port 2>/dev/null || echo ${DEFAULT_PORT})
log "Host port='${BIND_PORT}'"

writef "[Unit]"
writef "Description=StackStorm ${ST2SVC} Socket generated by $0"
writef "PartOf=${ST2SVC}.service"
writef ""
writef "[Socket]"
writef "ListenStream=${BIND_HOST}:${BIND_PORT}"
writef ""
writef "[Install]"
writef "WantedBy=sockets.target"

log "${ST2SVC} generated."
